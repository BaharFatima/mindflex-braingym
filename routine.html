<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Routine & Tasks</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --blue-deep: #0D47A1;
    --blue-mid: #1565C0;
    --blue-bright: #1E88E5;
    --blue-light: #64B5F6;
    --card-bg: rgba(255,255,255,0.85);
    --accent: #1E88E5;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(180deg, #B3E5FC 0%, #E1F5FE 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  .viewport {
    width: 320px;
    height: 640px;
    border-radius: 30px;
    background: linear-gradient(160deg, #BBDEFB 0%, #E3F2FD 100%);
    box-shadow: 0 20px 60px rgba(13,71,161,0.25), 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .blob { position: absolute; border-radius: 50%; filter: blur(40px); opacity: 0.35; pointer-events: none; z-index: 0; }
  .blob-1 { width: 180px; height: 180px; background: #64B5F6; top: -60px; right: -50px; }
  .blob-2 { width: 120px; height: 120px; background: #1E88E5; bottom: 80px; left: -40px; }

  /* Header */
  .header { padding: 14px 14px 8px; position: relative; z-index: 2; }
  .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
  .back-btn {
    width: 32px; height: 32px; border-radius: 50%;
    background: rgba(255,255,255,0.75); border: none; cursor: pointer;
    color: var(--blue-mid); display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.15s; flex-shrink: 0;
  }
  .back-btn:hover { transform: scale(1.08); }
  .header-center { text-align: center; flex: 1; }
  .header h1 { font-size: 15px; font-weight: 800; color: var(--blue-deep); letter-spacing: -0.5px; }
  .header-date { font-size: 10px; color: var(--blue-bright); font-weight: 500; opacity: 0.85; }

  /* Tabs */
  .tabs { display: flex; gap: 6px; padding: 0 14px; margin-bottom: 6px; position: relative; z-index: 2; }
  .tab {
    flex: 1; padding: 6px 4px; border-radius: 12px;
    background: rgba(255,255,255,0.5); border: 1.5px solid rgba(255,255,255,0.8);
    color: var(--blue-mid); cursor: pointer; font-weight: 600; font-size: 11px;
    font-family: 'Poppins', sans-serif; transition: all 0.2s; backdrop-filter: blur(4px);
  }
  .tab.active {
    background: linear-gradient(135deg, #64B5F6, #1E88E5); color: white;
    border-color: transparent; box-shadow: 0 4px 12px rgba(30,136,229,0.35); transform: translateY(-1px);
  }

  /* Date strip */
  .date-strip { display: flex; gap: 5px; padding: 0 14px 8px; overflow-x: auto; scrollbar-width: none; position: relative; z-index: 2; }
  .date-strip::-webkit-scrollbar { display: none; }
  .date-chip {
    min-width: 38px; padding: 5px 3px; border-radius: 11px;
    background: rgba(255,255,255,0.55); border: 1.5px solid rgba(255,255,255,0.8);
    text-align: center; cursor: pointer; font-size: 9px; font-weight: 600;
    color: var(--blue-mid); transition: all 0.2s; flex-shrink: 0;
  }
  .date-chip .day-num { font-size: 13px; font-weight: 700; display: block; }
  .date-chip.today { background: linear-gradient(135deg, #64B5F6, #1E88E5); color: white; border-color: transparent; box-shadow: 0 4px 10px rgba(30,136,229,0.3); }
  .date-chip.active-chip { background: rgba(255,255,255,0.85); color: var(--blue-deep); border-color: #90CAF9; box-shadow: 0 2px 8px rgba(30,136,229,0.15); }

  /* Progress */
  .progress-bar-wrap { padding: 0 14px 6px; position: relative; z-index: 2; }
  .progress-top { display: flex; justify-content: space-between; font-size: 10px; font-weight: 600; color: var(--blue-mid); margin-bottom: 4px; }
  .progress-track { height: 5px; border-radius: 10px; background: rgba(255,255,255,0.5); overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, #64B5F6, #1E88E5); transition: width 0.6s cubic-bezier(0.34,1.56,0.64,1); }

  /* Scroll area */
  .scroll-area { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0 12px 90px; scrollbar-width: none; position: relative; z-index: 2; }
  .scroll-area::-webkit-scrollbar { display: none; }

  /* Section header */
  .section-title { display: flex; align-items: center; gap: 7px; margin: 12px 0 6px; }
  .section-icon { font-size: 14px; }
  .section-label { font-size: 12px; font-weight: 700; color: var(--blue-deep); }
  .section-line { flex: 1; height: 1.5px; background: linear-gradient(90deg, rgba(30,136,229,0.25), transparent); border-radius: 2px; }
  .section-count { font-size: 10px; font-weight: 700; color: white; background: linear-gradient(135deg, #64B5F6, #1E88E5); border-radius: 20px; padding: 1px 7px; }

  /* Card */
  .card {
    display: flex; align-items: center; gap: 9px;
    background: var(--card-bg); backdrop-filter: blur(8px);
    padding: 10px 11px; border-radius: 14px;
    box-shadow: 0 4px 14px rgba(13,71,161,0.08), 0 1px 3px rgba(0,0,0,0.05);
    margin-bottom: 7px; border: 1.5px solid rgba(255,255,255,0.9);
    transition: transform 0.18s, box-shadow 0.18s;
    animation: slideUp 0.3s ease both;
  }
  .card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(13,71,161,0.12); }
  .card.completed { opacity: 0.55; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .check-wrap {
    width: 24px; height: 24px; flex-shrink: 0; border-radius: 50%;
    border: 2.5px solid #90CAF9; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.7);
  }
  .check-wrap.checked { background: linear-gradient(135deg, #64B5F6, #1E88E5); border-color: transparent; box-shadow: 0 2px 8px rgba(30,136,229,0.4); }
  .check-wrap .checkmark { display: none; color: white; font-size: 12px; font-weight: 700; }
  .check-wrap.checked .checkmark { display: block; }

  .task-meta { flex: 1; min-width: 0; }
  .task-title { font-size: 12px; font-weight: 700; color: var(--blue-deep); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .completed .task-title { text-decoration: line-through; color: #90CAF9; }
  .task-time-row { display: flex; align-items: center; gap: 4px; margin-top: 2px; }
  .task-time-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--blue-light); flex-shrink: 0; }
  .task-time { font-size: 10px; color: #64B5F6; font-weight: 500; }
  .task-date-badge { font-size: 9px; color: #1E88E5; background: #E3F2FD; border-radius: 6px; padding: 1px 5px; margin-top: 2px; display: inline-block; font-weight: 500; }

  .delete-btn { background: rgba(229,115,115,0.1); border: none; padding: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; flex-shrink: 0; }
  .delete-btn:hover { background: rgba(229,115,115,0.22); }
  .delete-btn svg { width: 13px; height: 13px; }

  /* Empty / Loading */
  .empty { text-align: center; padding: 30px 20px; color: var(--blue-mid); }
  .empty-icon { font-size: 32px; margin-bottom: 10px; }
  .loading { text-align: center; padding: 30px 20px; color: var(--blue-mid); opacity: 0.6; }
  .spinner { width: 28px; height: 28px; border: 3px solid rgba(30,136,229,0.2); border-top-color: #1E88E5; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ========== STANDARD NAV BAR STYLES ========== */
  .bottom-nav {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: #FFFFFF;
    border-top: 1px solid #E3F2FD;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.08);
    padding: 8px 5px;
    z-index: 50;
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 2px;
    flex: 1;
    text-decoration: none;
  }

  .nav-icon {
    width: 30px;
    height: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    color: #90CAF9;
  }

  .nav-icon i { 
    font-size: 18px; 
    transition: all 0.3s ease; 
  }

  .nav-label {
    font-size: 9px;
    color: #5f6368;
    text-align: center;
    line-height: 1.2;
    font-weight: 600;
  }

  .nav-item.selected .nav-icon i {
    transform: translateY(-8px) scale(1.2);
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .nav-item[data-category="cv"].selected .nav-icon i { color: #0D47A1; }
  .nav-item[data-category="achievements"].selected .nav-icon i { color: #9c27b0; }
  .nav-item[data-category="home"].selected .nav-icon i { color: #1565C0; }
  .nav-item[data-category="habit-tracker"].selected .nav-icon i { color: #ff4081; }
  .nav-item[data-category="user-account"].selected .nav-icon i { color: #00838F; }

  .nav-icon img {
    width: 18px;
    height: 18px;
    transition: all 0.3s ease;
    object-fit: contain;
    filter: grayscale(100%) brightness(0.7);
    border-radius: 6px;
  }

  .nav-item.selected .nav-icon img {
    transform: translateY(-8px) scale(1.2);
    filter: grayscale(0%) brightness(1.1) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
    border-radius: 8px;
  }

  .nav-icon .fallback-icon {
    width: 18px;
    height: 18px;
    background-color: #90CAF9;
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .nav-item.selected .nav-icon .fallback-icon {
    transform: translateY(-8px) scale(1.2);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
  }

  .nav-item[data-category="habit-tracker"].selected .nav-icon .fallback-icon {
    background-color: #ff4081;
  }

  .nav-item[data-category="cv"].selected .nav-icon .fallback-icon {
    background-color: #0D47A1;
  }

  /* FAB */
  .fab {
    position: absolute; bottom: 80px; right: 16px;
    width: 50px; height: 50px; border-radius: 50%; border: none;
    background: linear-gradient(135deg, #64B5F6 0%, #1E88E5 60%, #1565C0 100%);
    color: white; font-size: 26px; cursor: pointer; z-index: 50;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.18s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.18s;
    animation: fabPulse 2.8s ease-in-out infinite;
  }
  .fab:hover { transform: scale(1.12) rotate(15deg); box-shadow: 0 10px 30px rgba(30,136,229,0.65); }
  .fab:active { transform: scale(0.93); }
  @keyframes fabPulse {
    0%,100% { box-shadow: 0 6px 20px rgba(30,136,229,0.55), 0 0 0 0 rgba(30,136,229,0.35); }
    50% { box-shadow: 0 6px 20px rgba(30,136,229,0.55), 0 0 0 9px rgba(30,136,229,0); }
  }

  /* Popup */
  .popup { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13,71,161,0.25); backdrop-filter: blur(4px); z-index: 70; border-radius: 30px; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .popup-inner { background: white; width: 88%; margin: 50px auto 0; padding: 16px 15px; border-radius: 22px; box-shadow: 0 20px 60px rgba(13,71,161,0.2); border: 1.5px solid rgba(100,181,246,0.2); max-height: 82%; overflow-y: auto; scrollbar-width: none; animation: popIn 0.25s cubic-bezier(0.34,1.56,0.64,1); }
  .popup-inner::-webkit-scrollbar { display: none; }
  @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  .popup-title { font-size: 15px; font-weight: 800; color: var(--blue-deep); margin-bottom: 12px; text-align: center; }
  .form-label { font-size: 10px; font-weight: 700; color: var(--blue-mid); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 4px; margin-top: 10px; display: block; }
  .form-input { width: 100%; padding: 9px 11px; border-radius: 11px; border: 1.5px solid #E3F2FD; background: #F8FBFF; font-family: 'Poppins', sans-serif; font-size: 12px; color: var(--blue-deep); outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
  .form-input:focus { border-color: var(--blue-light); box-shadow: 0 0 0 3px rgba(100,181,246,0.15); }
  .date-btn { width: 100%; padding: 9px 11px; border-radius: 11px; border: 1.5px solid #E3F2FD; background: #F8FBFF; font-family: 'Poppins', sans-serif; font-size: 12px; color: var(--blue-mid); text-align: left; cursor: pointer; transition: border-color 0.2s; }
  .date-btn:hover { border-color: var(--blue-light); }
  .section-select-wrap { display: flex; gap: 7px; }
  .section-add-btn { padding: 0 11px; border-radius: 11px; border: 1.5px solid #E3F2FD; background: #F8FBFF; color: var(--blue-mid); font-size: 17px; cursor: pointer; }
  .btn-row { display: flex; gap: 7px; margin-top: 14px; }
  .btn { flex: 1; padding: 10px; border-radius: 13px; border: none; font-weight: 700; font-size: 12px; font-family: 'Poppins', sans-serif; cursor: pointer; transition: transform 0.15s; }
  .btn:active { transform: scale(0.96); }
  .btn-primary { background: linear-gradient(135deg, #64B5F6, #1E88E5); color: white; box-shadow: 0 4px 14px rgba(30,136,229,0.35); }
  .btn-muted { background: #E3F2FD; color: var(--blue-mid); }

  /* Calendar */
  .cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 3px; text-align: center; }
  .cal-day-head { font-size: 9px; color: #90CAF9; font-weight: 700; padding: 4px 0; }
  .cal-day { padding: 6px 0; border-radius: 9px; font-size: 11px; cursor: pointer; color: var(--blue-deep); font-weight: 600; transition: background 0.15s; }
  .cal-day:hover { background: #E3F2FD; }
  .cal-day.today { background: linear-gradient(135deg, #64B5F6, #1E88E5); color: white; }
  .cal-day.blank { cursor: default; }
  .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .cal-nav button { background: #E3F2FD; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 13px; color: var(--blue-mid); }
  .cal-month-label { font-size: 13px; font-weight: 700; color: var(--blue-deep); }

  /* Toast */
  .toast { position: absolute; bottom: 88px; left: 50%; transform: translateX(-50%); background: #1C1C1E; color: white; padding: 7px 16px; border-radius: 20px; font-size: 11px; font-weight: 600; white-space: nowrap; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .toast.show { opacity: 1; }
</style>
</head>
<body>
<div class="viewport" id="viewport">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <button class="back-btn" onclick="window.location.href='home.html'" title="Back">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <div class="header-center">
        <h1>My Tasks</h1>
        <div class="header-date" id="headerDate"></div>
      </div>
      <div style="width:32px"></div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchView('daily',event)">Daily</button>
    <button class="tab" onclick="switchView('weekly',event)">Weekly</button>
    <button class="tab" onclick="switchView('monthly',event)">Monthly</button>
  </div>

  <!-- Date strip -->
  <div class="date-strip" id="dateStrip"></div>

  <!-- Progress -->
  <div class="progress-bar-wrap">
    <div class="progress-top"><span>Progress</span><span id="progressLabel">0 / 0</span></div>
    <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>

  <!-- Content -->
  <div class="scroll-area" id="content">
    <div class="loading"><div class="spinner"></div><p style="font-size:12px;">Loading tasks...</p></div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openAddPopup()" aria-label="Add task">+</button>

  <!-- FIXED NAV BAR -->
  <nav class="bottom-nav">
    <a href="cv.html" class="nav-item" data-category="cv">
      <div class="nav-icon">
        <img src="cv.png" alt="CV" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="fallback-icon" style="display: none;">
          <i class="fas fa-file-alt"></i>
        </div>
      </div>
      <div class="nav-label">CV</div>
    </a>

    <a href="achievements.html" class="nav-item" data-category="achievements">
      <div class="nav-icon"><i class="fas fa-trophy"></i></div>
      <div class="nav-label">Achievements</div>
    </a>

    <a href="home.html" class="nav-item" data-category="home">
      <div class="nav-icon"><i class="fas fa-home"></i></div>
      <div class="nav-label">Home</div>
    </a>

    <a href="habittracker.html" class="nav-item" data-category="habit-tracker">
      <div class="nav-icon">
        <img src="https://z-cdn-media.chatglm.cn/files/a1979dda-a3e4-4b38-b0cf-00e4ad455277_pasted_image_1762936027415.png?auth_key=1862936037-6cc8a5a356484e1cb70a8f599e1f2ce8-0-496c548f3f7ef2ea6a808a3cc812dc2c" alt="Habit Tracker" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="fallback-icon" style="display: none;"><i class="fas fa-check"></i></div>
      </div>
      <div class="nav-label">Habit Tracker</div>
    </a>

    <a href="profile.html" class="nav-item" data-category="user-account">
      <div class="nav-icon"><i class="fas fa-user-circle"></i></div>
      <div class="nav-label">Account</div>
    </a>
  </nav>

  <div class="toast" id="toast"></div>

  <!-- Add Task Popup -->
  <div id="addPopup" class="popup" onclick="if(event.target===this) closeAddPopup();">
    <div class="popup-inner">
      <div class="popup-title">‚ú¶ Add Task</div>
      <label class="form-label">Title</label>
      <input id="taskTitle" type="text" class="form-input" placeholder="What needs to be done?">
      <label class="form-label">Time</label>
      <input id="taskTime" type="time" class="form-input">
      <label class="form-label">Date</label>
      <button class="date-btn" onclick="openCalendar()"><span id="selectedDateLabel">üìÖ Choose Date</span></button>
      <label class="form-label">Section</label>
      <div class="section-select-wrap">
        <select id="taskSection" class="form-input" style="cursor:pointer;"></select>
        <button class="section-add-btn" onclick="openAddSectionPopup()">+</button>
      </div>
      <div class="btn-row">
        <button onclick="closeAddPopup()" class="btn btn-muted">Cancel</button>
        <button id="saveBtn" class="btn btn-primary">Save ‚úì</button>
      </div>
    </div>
  </div>

  <!-- Calendar Popup -->
  <div id="calendarPopup" class="popup" onclick="if(event.target===this) closeCalendar();">
    <div class="popup-inner">
      <div class="cal-nav">
        <button onclick="prevMonth()">‚Üê</button>
        <div class="cal-month-label" id="calMonthLabel"></div>
        <button onclick="nextMonth()">‚Üí</button>
      </div>
      <div class="cal-grid" id="calendarGrid">
        <div class="cal-day-head">Su</div><div class="cal-day-head">Mo</div>
        <div class="cal-day-head">Tu</div><div class="cal-day-head">We</div>
        <div class="cal-day-head">Th</div><div class="cal-day-head">Fr</div>
        <div class="cal-day-head">Sa</div>
      </div>
    </div>
  </div>

  <!-- Add Section Popup -->
  <div id="addSectionPopup" class="popup" onclick="if(event.target===this) closeAddSectionPopup();">
    <div class="popup-inner">
      <div class="popup-title">Add Section</div>
      <label class="form-label">Section Name</label>
      <input id="newSectionName" class="form-input" placeholder="e.g., Study, Work...">
      <div class="btn-row" style="margin-top:12px;">
        <button onclick="closeAddSectionPopup()" class="btn btn-muted">Cancel</button>
        <button onclick="addSection()" class="btn btn-primary">Add</button>
      </div>
    </div>
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  getFirestore,
  collection,
  addDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  doc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// üî• Your Firebase config
const firebaseConfig = {
 apiKey: "AIzaSyD9bnmF1N44Nkuk3WZQjK9z4gRE00VRmCY",
  authDomain: "mindflex-b2a0c.firebaseapp.com",
  projectId: "mindflex-b2a0c",
  storageBucket: "mindflex-b2a0c.firebasestorage.app",
  messagingSenderId: "148676867562",
  appId: "1:148676867562:web:3365a72b6fa6b3751cee93",
  measurementId: "G-Q2T6HD3S0E"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

let tasks = { all: [], sections: ["morning","afternoon","evening","night"] };

async function db_loadTasks() {
  const q = query(
    collection(db, "users", currentUser.uid, "tasks"),
    orderBy("date")
  );

  const snap = await getDocs(q);

  return snap.docs.map(d => ({
    id: d.id,
    ...d.data()
  }));
}

async function db_saveTask(task) {
  const { id, ...data } = task;

  const ref = await addDoc(
    collection(db, "users", currentUser.uid, "tasks"),
    data
  );

  return ref.id;
}

async function db_updateTask(id, changes) {
  await updateDoc(
    doc(db, "users", currentUser.uid, "tasks", id),
    changes
  );
}

async function db_deleteTask(id) {
  await deleteDoc(
    doc(db, "users", currentUser.uid, "tasks", id)
  );
}

/* ================================================================
   UTILITIES
   ================================================================ */
function uid(){ return 't'+Date.now()+Math.floor(Math.random()*9999); }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function localDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function todayLocal(){ return localDate(new Date()); }
function showToast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2200); }

const SECTION_META = {
  morning:{icon:'üåÖ',label:'Morning'}, afternoon:{icon:'‚òÄÔ∏è',label:'Afternoon'},
  evening:{icon:'üåÜ',label:'Evening'}, night:{icon:'üåô',label:'Night'}, anytime:{icon:'üóÇÔ∏è',label:'Anytime'}
};
function getSectionMeta(s){ return SECTION_META[s]||{icon:'üìå',label:s.charAt(0).toUpperCase()+s.slice(1)}; }

/* ================================================================
   VIEW STATE
   ================================================================ */
let currentView = "daily";
let selectedDayStr = todayLocal();

function updateHeaderDate(dateStr){
  const d=new Date(dateStr+'T12:00');
  document.getElementById("headerDate").textContent=d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
}
updateHeaderDate(selectedDayStr);

function buildDateStrip(){
  const strip=document.getElementById("dateStrip"); strip.innerHTML="";
  const today=new Date(), todayStr=localDate(today);
  for(let i=-3;i<=3;i++){
    const d=new Date(today); d.setDate(today.getDate()+i);
    const dStr=localDate(d), isToday=dStr===todayStr, isActive=dStr===selectedDayStr;
    const chip=document.createElement("div");
    chip.className="date-chip"+(isToday?" today":"")+(isActive&&!isToday?" active-chip":"");
    chip.innerHTML=`<span class="day-num">${d.getDate()}</span>${d.toLocaleDateString('en-US',{weekday:'short'}).slice(0,2)}`;
    chip.addEventListener('click',()=>selectDayChip(dStr));
    strip.appendChild(chip);
  }
  strip.style.display="flex";
}

function selectDayChip(dStr){ selectedDayStr=dStr; updateHeaderDate(dStr); buildDateStrip(); if(currentView==="daily") loadTasks("daily"); }

function switchView(type,event){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  if(event&&event.target) event.target.classList.add("active");
  currentView=type;
  document.getElementById("dateStrip").style.display=type==="daily"?"flex":"none";
  loadTasks(type);
}

function updateProgress(list){
  const total=list.length, done=list.filter(t=>t.completed).length;
  document.getElementById("progressLabel").textContent=`${done} / ${total}`;
  document.getElementById("progressFill").style.width=(total?Math.round((done/total)*100):0)+"%";
}

/* ================================================================
   RENDER
   ================================================================ */
function loadTasks(type){
  const container=document.getElementById("content"); container.innerHTML="";
  let list=tasks.all.slice();

  if(type==="daily"){
    list=list.filter(t=>t.date===selectedDayStr); updateProgress(list);
    if(!list.length){
      const isFuture=selectedDayStr>todayLocal();
      container.innerHTML=`<div class="empty"><div class="empty-icon">${isFuture?'üóìÔ∏è':'‚ú®'}</div><p style="opacity:0.25;font-size:16px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px;">No tasks added yet</p><p style="font-size:11px;opacity:0.5;">${isFuture?'Plan ahead ‚Äî tap + to add.':'Tap + to add a task!'}</p></div>`;
      return;
    }
    renderBySection(list,container);

  } else if(type==="weekly"){
    const now=new Date();
    const start=new Date(now); start.setDate(now.getDate()-now.getDay()); start.setHours(0,0,0,0);
    const end=new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
    list=list.filter(t=>t.date&&new Date(t.date+'T12:00')>=start&&new Date(t.date+'T12:00')<=end);
    updateProgress(list);
    if(!list.length){ container.innerHTML=`<div class="empty"><div class="empty-icon">üìÖ</div><p style="opacity:0.25;font-size:16px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px;">No tasks added yet</p><p style="font-size:11px;opacity:0.5;">Nothing scheduled this week.</p></div>`; return; }
    const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const DAY_ICONS=['‚òÄÔ∏è','üå±','üî•','‚ö°','üéØ','üåä','üåô'];
    const dayMap={};
    for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); dayMap[localDate(d)]=[]; }
    list.forEach(t=>{ if(dayMap[t.date]!==undefined) dayMap[t.date].push(t); });
    let delay=0;
    Object.entries(dayMap).forEach(([dateStr,items])=>{
      if(!items.length) return;
      const d=new Date(dateStr+'T12:00'), dayIdx=d.getDay(), isToday=dateStr===todayLocal();
      const incomplete=items.filter(t=>!t.completed).length;
      container.insertAdjacentHTML('beforeend',`<div class="section-title"><span class="section-icon">${DAY_ICONS[dayIdx]}</span><span class="section-label">${DAY_NAMES[dayIdx]}${isToday?' <span style="font-size:9px;color:#64B5F6;">(today)</span>':''}</span><div class="section-line"></div>${incomplete>0?`<span class="section-count">${incomplete}</span>`:''}</div>`);
      items.sort((a,b)=>(a.completed===b.completed)?0:(a.completed?1:-1));
      items.forEach(task=>{ container.insertAdjacentHTML('beforeend',renderCard(task,delay)); delay+=50; attachEvents(task.id); });
    });

  } else if(type==="monthly"){
    const now=new Date(), y=now.getFullYear();
    list=list.filter(t=>{ if(!t.date) return false; return new Date(t.date+'T12:00').getFullYear()===y; });
    updateProgress(list);
    if(!list.length){ container.innerHTML=`<div class="empty"><div class="empty-icon">üóìÔ∏è</div><p style="opacity:0.25;font-size:16px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px;">No tasks added yet</p><p style="font-size:11px;opacity:0.5;">Nothing scheduled this year.</p></div>`; return; }
    const MONTH_NAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
    const MONTH_ICONS=['‚ùÑÔ∏è','üíù','üå∏','üåßÔ∏è','üåª','‚òÄÔ∏è','üèñÔ∏è','üçÇ','üéí','üéÉ','üçÅ','üéÑ'];
    const monthMap={}; for(let m=0;m<12;m++) monthMap[m]=[];
    list.forEach(t=>{ monthMap[new Date(t.date+'T12:00').getMonth()].push(t); });
    let delay=0;
    Object.entries(monthMap).forEach(([m,items])=>{
      if(!items.length) return;
      const mi=parseInt(m), isCurrent=mi===now.getMonth(), incomplete=items.filter(t=>!t.completed).length;
      container.insertAdjacentHTML('beforeend',`<div class="section-title"><span class="section-icon">${MONTH_ICONS[mi]}</span><span class="section-label">${MONTH_NAMES[mi]}${isCurrent?' <span style="font-size:9px;color:#64B5F6;">(this month)</span>':''}</span><div class="section-line"></div>${incomplete>0?`<span class="section-count">${incomplete}</span>`:''}</div>`);
      items.sort((a,b)=>a.date>b.date?1:-1);
      items.forEach(task=>{ container.insertAdjacentHTML('beforeend',renderCard(task,delay)); delay+=50; attachEvents(task.id); });
    });
  }
}

function renderBySection(list,container){
  const sectionsMap={}; tasks.sections.forEach(s=>sectionsMap[s]=[]); sectionsMap.anytime=[];
  list.forEach(t=>{ const sec=t.section&&sectionsMap[t.section]?t.section:'anytime'; sectionsMap[sec].push(t); });
  let delay=0;
  [...tasks.sections,'anytime'].forEach(sec=>{
    if(!sectionsMap[sec]||!sectionsMap[sec].length) return;
    const meta=getSectionMeta(sec), items=sectionsMap[sec].sort((a,b)=>(a.completed===b.completed)?0:(a.completed?1:-1));
    const incomplete=items.filter(t=>!t.completed).length;
    container.insertAdjacentHTML('beforeend',`<div class="section-title"><span class="section-icon">${meta.icon}</span><span class="section-label">${meta.label}</span><div class="section-line"></div>${incomplete>0?`<span class="section-count">${incomplete}</span>`:''}</div>`);
    items.forEach(task=>{ container.insertAdjacentHTML('beforeend',renderCard(task,delay)); delay+=50; attachEvents(task.id); });
  });
}

function renderCard(task,delay){
  const cls="card"+(task.completed?" completed":"");
  const title=escapeHtml(task.title||""), time=escapeHtml(task.time||"");
  const timeRow=time?`<div class="task-time-row"><div class="task-time-dot"></div><div class="task-time">${time}</div></div>`:'';
  const dateBadge=task.date?`<div class="task-date-badge">${new Date(task.date+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>`:'';
  return `<div class="${cls}" data-id="${task.id}" style="animation-delay:${delay}ms"><div class="check-wrap ${task.completed?'checked':''}" data-id="${task.id}"><span class="checkmark">‚úì</span></div><div class="task-meta"><div class="task-title">${title}</div>${timeRow}${dateBadge}</div><button class="delete-btn" data-id="${task.id}" aria-label="Delete"><svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="#EF9A9A" stroke-width="2" stroke-linecap="round"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="#EF9A9A" stroke-width="2" stroke-linecap="round"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6" stroke="#EF9A9A" stroke-width="2" stroke-linecap="round"/></svg></button></div>`;
}

function attachEvents(id){
  const card=document.querySelector(`.card[data-id="${id}"]`); if(!card) return;
  card.querySelector('.check-wrap').addEventListener('click',()=>toggleComplete(id));
  card.querySelector('.delete-btn').addEventListener('click',()=>removeTask(id));
}

/* ================================================================
   ACTIONS
   ================================================================ */
async function toggleComplete(id){
  const idx=tasks.all.findIndex(t=>t.id===id); if(idx===-1) return;
  tasks.all[idx].completed=!tasks.all[idx].completed;
  const completed=tasks.all[idx].completed;
  const item=tasks.all.splice(idx,1)[0];
  if(item.completed){ tasks.all.push(item); } else {
    let ins=tasks.all.length;
    for(let i=0;i<tasks.all.length;i++){ if(tasks.all[i].section===item.section&&tasks.all[i].completed){ ins=i; break; } }
    tasks.all.splice(ins,0,item);
  }
  loadTasks(currentView);
  await db_updateTask(id,{completed});
}

async function removeTask(id){
  tasks.all=tasks.all.filter(t=>t.id!==id);
  loadTasks(currentView);
  showToast("Task deleted");
  await db_deleteTask(id);
}

/* Add task */
let selectedDate=new Date();
function openAddPopup(){
  populateSectionSelect();
  selectedDate=new Date(selectedDayStr+'T12:00');
  document.getElementById("selectedDateLabel").innerText='üìÖ '+selectedDate.toDateString();
  document.getElementById("addPopup").style.display="block";
}
function closeAddPopup(){ document.getElementById("addPopup").style.display="none"; }

function populateSectionSelect(){
  const sel=document.getElementById("taskSection"); sel.innerHTML="";
  tasks.sections.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=getSectionMeta(s).label; sel.appendChild(o); });
  const a=document.createElement('option'); a.value='anytime'; a.textContent='Anytime'; sel.appendChild(a);
}

document.getElementById("saveBtn").addEventListener('click',async()=>{
  const title=document.getElementById("taskTitle").value.trim();
  const time=document.getElementById("taskTime").value;
  const section=document.getElementById("taskSection").value||"anytime";
  if(!title){ showToast("Enter a task title"); return; }
  const dateStr=localDate(selectedDate);
  const newTask={id:uid(),title,time,section,date:dateStr,completed:false};
  tasks.all.push(newTask);
  if(currentView==="daily"){ selectedDayStr=dateStr; buildDateStrip(); updateHeaderDate(dateStr); }
  document.getElementById("taskTitle").value="";
  document.getElementById("taskTime").value="";
  closeAddPopup(); loadTasks(currentView);
  showToast("Task saved ‚úì");
  const dbId=await db_saveTask(newTask);
  if(dbId&&dbId!==newTask.id){ const idx=tasks.all.findIndex(t=>t.id===newTask.id); if(idx!==-1) tasks.all[idx].id=dbId; }
});

/* Section */
function openAddSectionPopup(){ document.getElementById("addSectionPopup").style.display="block"; document.getElementById("newSectionName").value=""; }
function closeAddSectionPopup(){ document.getElementById("addSectionPopup").style.display="none"; }
function addSection(){
  const name=document.getElementById("newSectionName").value.trim(); if(!name){ showToast("Enter a section name"); return; }
  const key=name.toLowerCase().replace(/\s+/g,'-');
  if(!tasks.sections.includes(key)) tasks.sections.push(key);
  closeAddSectionPopup(); populateSectionSelect(); loadTasks(currentView);
}

/* Calendar */
let currentCalendarDate=new Date();
function openCalendar(){ document.getElementById("calendarPopup").style.display="block"; renderCalendarGrid(currentCalendarDate); }
function closeCalendar(){ document.getElementById("calendarPopup").style.display="none"; }
function prevMonth(){ currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); renderCalendarGrid(currentCalendarDate); }
function nextMonth(){ currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); renderCalendarGrid(currentCalendarDate); }
function renderCalendarGrid(dateObj){
  const year=dateObj.getFullYear(), month=dateObj.getMonth();
  document.getElementById("calMonthLabel").textContent=dateObj.toLocaleString('default',{month:'long'})+' '+year;
  const firstDay=new Date(year,month,1).getDay(), totalDays=new Date(year,month+1,0).getDate(), todayIso=todayLocal();
  const grid=document.getElementById("calendarGrid");
  const headers=Array.from(grid.querySelectorAll('.cal-day-head')); grid.innerHTML=""; headers.forEach(h=>grid.appendChild(h));
  for(let i=0;i<firstDay;i++){ const d=document.createElement('div'); d.className='cal-day blank'; grid.appendChild(d); }
  for(let d=1;d<=totalDays;d++){
    const iso=localDate(new Date(year,month,d)), div=document.createElement('div');
    div.className='cal-day'+(iso===todayIso?' today':''); div.textContent=d; div.onclick=()=>pickDate(year,month,d); grid.appendChild(div);
  }
}
function pickDate(y,m,d){ selectedDate=new Date(y,m,d); document.getElementById("selectedDateLabel").innerText='üìÖ '+selectedDate.toDateString(); closeCalendar(); }

async function init() {
  tasks.all = await db_loadTasks();
  buildDateStrip();
  loadTasks("daily");
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "loginmain.html";
    return;
  }

  currentUser = user;
  await init();
});

// Make module functions accessible to inline HTML onclick
window.switchView = switchView;
window.openAddPopup = openAddPopup;
window.closeAddPopup = closeAddPopup;
window.openAddSectionPopup = openAddSectionPopup;
window.closeAddSectionPopup = closeAddSectionPopup;
window.addSection = addSection;
window.openCalendar = openCalendar;
window.closeCalendar = closeCalendar;
window.prevMonth = prevMonth;
window.nextMonth = nextMonth;
</script>
</body>
</html>
